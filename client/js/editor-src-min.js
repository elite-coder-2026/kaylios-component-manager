import{EditorState,Compartment}from"@codemirror/state";import{EditorView,keymap,lineNumbers,highlightActiveLineGutter}from"@codemirror/view";import{defaultKeymap,history,historyKeymap}from"@codemirror/commands";import{javascript}from"@codemirror/lang-javascript";import{html}from"@codemirror/lang-html";import{css}from"@codemirror/lang-css";const editorRoot=document.getElementById("editor"),tabs=Array.from(document.querySelectorAll(".editor__tab")),fileItems=Array.from(document.querySelectorAll(".file-item")),extensionByLang={html:html(),javascript:javascript(),scss:css()},emptyContent={html:"\x3c!-- select a component --\x3e",javascript:"// select a component",scss:"// select a component"};let activeLang="html",currentContent={...emptyContent};function setActiveTab(t){activeLang=t,tabs.forEach((e=>{e.setAttribute("aria-selected",e.dataset.lang===t?"true":"false")}))}function replaceDoc(t,e){t.dispatch({changes:{from:0,to:t.state.doc.length,insert:e}})}async function fetchTextFirstOk(t){for(const e of t)try{const t=await fetch(e);if(!t.ok)continue;return{ok:!0,path:e,text:await t.text()}}catch{}return{ok:!1,path:t[0],text:""}}async function loadComponent(t,e,s="main"){const o=`../components/${t}/${e}`,n=`components/${t}/${e}`,c=`../components/${t}/${e}.component`,r=`components/${t}/${e}.component`,a="angular"===t?{html:[`${c}.html`,`${r}.html`,`${o}.html`,`${n}.html`],javascript:"spec"===s?[`${c}.spec.ts`,`${r}.spec.ts`,`${c}.ts`,`${r}.ts`,`${o}.spec.ts`,`${n}.spec.ts`,`${o}.ts`,`${n}.ts`,`${o}.js`,`${n}.js`]:[`${c}.ts`,`${r}.ts`,`${o}.ts`,`${n}.ts`,`${o}.js`,`${n}.js`],scss:[`${c}.scss`,`${r}.scss`,`${o}.scss`,`${n}.scss`]}:{html:[`${o}.html`,`${n}.html`],javascript:[`${o}.js`,`${n}.js`],scss:[`${o}.scss`,`${n}.scss`]},i={};for(const t of Object.keys(a)){const e=await fetchTextFirstOk(a[t]);if(e.ok){i[t]=e.text;continue}const s=a[t][0];"html"===t&&(i[t]=`\x3c!-- Missing ${s} --\x3e`),"javascript"===t&&(i[t]=`// Missing ${s}`),"scss"===t&&(i[t]=`// Missing ${s}`)}currentContent=i}function setActiveFile(t){fileItems.forEach((e=>{e===t?e.setAttribute("aria-current","true"):e.removeAttribute("aria-current")}))}if(editorRoot){const t=new Compartment,e=new EditorView({state:EditorState.create({doc:currentContent[activeLang],extensions:[lineNumbers(),highlightActiveLineGutter(),history(),keymap.of([...defaultKeymap,...historyKeymap]),EditorView.lineWrapping,t.of(extensionByLang[activeLang])]}),parent:editorRoot});tabs.forEach((s=>{s.addEventListener("click",(()=>{const o=s.dataset.lang;setActiveTab(o),e.dispatch({effects:t.reconfigure(extensionByLang[o])}),replaceDoc(e,currentContent[o])}))})),fileItems.forEach((s=>{s.addEventListener("click",(async o=>{o.preventDefault(),setActiveFile(s);const n=s.dataset.framework,c=s.dataset.component,r=s.dataset.lang||"html",a=s.dataset.fileRole||"main";await loadComponent(n,c,a),setActiveTab(r),e.dispatch({effects:t.reconfigure(extensionByLang[r])}),replaceDoc(e,currentContent[r])}))}))}